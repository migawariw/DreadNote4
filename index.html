<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>DreadNote</title>
  <link rel="icon" href="/DreadNote/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="DreadNote/favicon2.png" sizes="180x180">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      padding: 17px;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      font-size: 17px;
      background: #ffffff;
      color: #1c1c1e;
    }

    section {
      max-width: 800px;
      margin: auto;
      position: relative;
    }

    [hidden] {
      display: none;
    }

    input,
    button {
      font-size: 17px;
      margin: 4px 0;
    }

    ul {
      padding-left: 0;
      margin: 0;
    }

    li {
      list-style: none;
      padding: 8px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      user-select: none;
      cursor: default;
    }

    li:hover {
      background: #f2f2f7;
    }

    li .memo-title {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 8px;
    }

    .menu-btn,
    .longpress-btn {
      user-select: none;
    }

    #title {
      border: none;
      background: transparent;
      color: inherit;
      font-size: 21px;
    }

    #editor {
      /* min-height: 70vh;*/
      min-height: 200vh;
      outline: none;
      white-space: pre-wrap;
      word-break: break-word;
      border-top: 1px solid #ccc;
      padding-top: 17px;

      /* iPhone„É°„É¢È¢® 16px„Åã„ÇâÂ§âÊõ¥*/
      font-size: 17px;
      line-height: 1.75;
      letter-spacing: 0.025em;
      color: #1c1c1e;
      /* iOSÊ®ôÊ∫ñ„ÉÜ„Ç≠„Çπ„ÉàËâ≤ */
    }

    #editor a {
      color: #1c1c1e;
      text-decoration: none;
    }

    #editor a:hover,
    #editor a:focus,
    #editor a:active {
      text-decoration: none;
    }


    img {
      width: 100%;
      height: 100%;
      display: block;
      margin: 8px 0;
    }

    .video {
      position: relative;
      width: 100%;
      /* padding-top: 56.25%; */
      margin: 12px auto;
    }

    .video iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    .memo-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-span {
      font-size: 0.7em;
      color: #666;
      flex-shrink: 0;
    }

    .menu-btn {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }

    .menu-popup {
      position: absolute;
      top: 100%;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      padding: 4px 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 10;
    }

    .menu-popup button {
      width: 100%;
      text-align: left;
      padding: 4px 12px;
      background: none;
      border: none;
      cursor: pointer;
    }

    .menu-popup button:hover {
      background: #eee;
    }

    #user-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
    }

    #user-menu {
      position: absolute;
      top: 60px;
      right: 0;
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: none;
      z-index: 100;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    #user-menu button {
      display: block;
      width: 100%;
      padding: 10px 16px;
      background: none;
      border: none;
      text-align: left;
      font-size: 15px;
    }

    #user-menu button:hover {
      background: #f2f2f7;
    }

    #toast {
      display: none;
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }

    #toast.show {
      display: block;
      opacity: 1;
      pointer-events: auto;
    }

    .preview-popup {
      display: none;
      position: fixed;
      background: #fff;
      border: 1px solid #333;
      padding: 8px;
      z-index: 1000;
      max-width: 80%;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    button {
      cursor: pointer;
    }

    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .longpress-btn {
      background: #eee;
      border: 1px solid #ccc;
      padding: 4px 8px;
      border-radius: 4px;
      user-select: none;
      cursor: pointer;
    }

    /* Disable underline on all links (including hover, focus, active, visited) */
    a,
    a:hover,
    a:focus,
    a:active,
    a:visited {
      text-decoration: none !important;
    }

    /* Dark mode styles */
    body.dark {
      background: #000;
      color: #f2f2f7;
    }

    body.dark #editor {
      color: #f2f2f7;
      border-top-color: #333;
    }

    body.dark li {
      border-bottom-color: #333;
    }

    body.dark li:hover {
      background: #1c1c1e;
    }

    body.dark #user-menu {
      background: #1c1c1e;
      border-color: #333;
    }

    body.dark #user-menu button {
      color: #f2f2f7;
    }

    body.dark #editor a {
      color: #f2f2f7;
    }


    /* „Éú„Çø„É≥„ÅÆÂü∫Êú¨„Çµ„Ç§„Ç∫ */
    .menu-btn,
    .longpress-btn {
      font-size: 18px;
      padding: 6px 12px;
      border-radius: 6px;
    }

    /* „Éú„Çø„É≥ÂÜÖ„Ç¢„Ç§„Ç≥„É≥„ÅÆ„Çµ„Ç§„Ç∫ */
    .menu-btn img,
    .longpress-btn img,
    #user-icon {
      width: 40px;
      height: 40px;
    }

    /* „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„É°„Éã„É•„Éº„ÅÆ„Çµ„Ç§„Ç∫ */
    .menu-popup {
      padding: 6px 0;
      border-radius: 6px;
    }

    .menu-popup button {
      font-size: 17px;
      padding: 8px 16px;
      border-radius: 6px;
    }

    /* „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂØæÂøú */
    body.dark .menu-btn,
    body.dark .longpress-btn {
      background: #1c1c1e;
      color: #f2f2f7;
      border-color: #333;
    }

    body.dark .menu-popup {
      background: #1c1c1e;
      border-color: #333;
    }

    body.dark .menu-popup button {
      color: #f2f2f7;
    }

    body.dark .menu-popup button:hover {
      background: #333;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>

<body>

  <section id="view-login">
    <h2>DreadNote Login</h2>
    <input id="email" placeholder="email"><br>
    <input id="password" type="password" placeholder="password"><br>
    <button id="login">Login</button>
    <button id="signup">Sign up</button><br><br>
    <button id="google-login">Login with Google</button>
  </section>

  <section id="view-list" hidden>
    <div class="flex-between">
      <h2>Notes</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="new-memo">Ôºã</button>
        <button id="go-trash">üóëÔ∏è</button>
        <img id="user-icon" src="" title="User Menu">
        <div id="user-menu">
          <button id="dark-btn">Darkmode</button>
          <button id="logout-btn">Logout</button>
        </div>
      </div>
    </div>
    <ul id="memo-list"></ul>
  </section>

  <section id="view-trash" hidden>
    <div class="flex-between">
      <h2>Trash üóëÔ∏è</h2>
      <button id="back-list"> ‚Üê </button>
    </div>
    <ul id="trash-list"></ul>
  </section>

  <section id="view-editor" hidden>
    <button id="back"> ‚Üê </button>
    <input id="title" placeholder="">
    <div id="editor" contenteditable="true"></div>
  </section>

  <div id="toast"></div>

  <div id="preview" class="preview-popup">
    <div id="preview-content"></div>
    <button id="copy-note">Copy</button>
    <button id="delete-note">Delete</button>
    <button id="close-preview">Close</button>
  </div>

  <script type="module">
    import { getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let metaCache = null;        // ‚Üê ÁõÆÊ¨°ÁÆ±
    const memoCache = {};       // ‚Üê Êú¨Êñá„Ç≠„É£„ÉÉ„Ç∑„É•

    /* FirebaseÂàùÊúüÂåñ */
    const firebaseConfig = { apiKey: "AIzaSyCdDf0GH80PoGlcbk2yjlaVQfP01Gk9m18", authDomain: "noteeditor-ba1db.firebaseapp.com", projectId: "noteeditor-ba1db" };
    const app = initializeApp( firebaseConfig );
    const auth = getAuth( app );
    const db = getFirestore( app );

    /* DOMË¶ÅÁ¥† */
    const views = { login: document.getElementById( 'view-login' ), list: document.getElementById( 'view-list' ), trash: document.getElementById( 'view-trash' ), editor: document.getElementById( 'view-editor' ) };
    const emailInput = document.getElementById( 'email' );
    const passwordInput = document.getElementById( 'password' );
    const memoList = document.getElementById( 'memo-list' );
    const trashList = document.getElementById( 'trash-list' );
    const editor = document.getElementById( 'editor' );
    const titleInput = document.getElementById( 'title' );
    const userIcon = document.getElementById( 'user-icon' );
    const userMenu = document.getElementById( 'user-menu' );

    // Dark mode toggle
    const darkBtn = document.getElementById( 'dark-btn' );

    if ( darkBtn ) {
      darkBtn.onclick = ( e ) => {
        e.stopPropagation();
        document.body.classList.toggle( 'dark' );
        localStorage.setItem(
          'dreadnote-dark',
          document.body.classList.contains( 'dark' ) ? '1' : '0'
        );
      };
    }

    // ÂàùÊúüÂåñÔºà‰øùÂ≠òÁä∂ÊÖã„ÇíÂèçÊò†Ôºâ
    if ( localStorage.getItem( 'dreadnote-dark' ) === '1' ) {
      document.body.classList.add( 'dark' );
    }
    const toast = document.getElementById( 'toast' );
    const preview = document.getElementById( 'preview' );
    const previewContent = document.getElementById( 'preview-content' );
    const copyBtn = document.getElementById( 'copy-note' );
    const deleteBtn = document.getElementById( 'delete-note' );
    const closePreview = document.getElementById( 'close-preview' );

    let currentMemoId = null;
    let longPressTimer = null;
    // let memosCache=[];

    /* „Éà„Éº„Çπ„ÉàË°®Á§∫ */
    function showToast( msg, d = 2000 ) { toast.textContent = msg; toast.classList.add( 'show' ); setTimeout( () => toast.classList.remove( 'show' ), d ); }
    function show( view ) { Object.values( views ).forEach( v => v.hidden = true ); views[view].hidden = false; }

    /* Auth */
    const provider = new GoogleAuthProvider();
    document.getElementById( 'login' ).onclick = async () => { try { await signInWithEmailAndPassword( auth, emailInput.value, passwordInput.value ); } catch ( e ) { showToast( "„É≠„Ç∞„Ç§„É≥Â§±Êïó: " + e.message ); } };
    document.getElementById( 'signup' ).onclick = async () => { try { await createUserWithEmailAndPassword( auth, emailInput.value, passwordInput.value ); } catch ( e ) { showToast( "„Çµ„Ç§„É≥„Ç¢„ÉÉ„ÉóÂ§±Êïó: " + e.message ); } };
    document.getElementById( 'google-login' ).onclick = async () => { try { await signInWithPopup( auth, provider ); } catch ( e ) { showToast( "Google„É≠„Ç∞„Ç§„É≥Â§±Êïó: " + e.message ); } };
    userIcon.onclick = () => { userMenu.style.display = ( userMenu.style.display === 'block' ) ? 'none' : 'block'; }
    const switchAccountBtn = document.getElementById( 'switch-account' );
    if ( switchAccountBtn ) {
      switchAccountBtn.onclick = async () => {
        userMenu.style.display = 'none';
        try {
          await signInWithPopup( auth, provider );
        } catch ( e ) {
          showToast( "ÂàáÊõøÂ§±Êïó" );
        }
      };
    }
    document.getElementById( 'logout-btn' ).onclick = () => { userMenu.style.display = 'none'; signOut( auth ); location.hash = '#login'; }
    document.addEventListener( 'click', e => {
      if ( !userMenu.contains( e.target ) && e.target !== userIcon ) userMenu.style.display = 'none';
      document.querySelectorAll( '.menu-popup' ).forEach( menu => {
        const btn = menu.previousSibling;
        if ( !menu.contains( e.target ) && !btn.contains( e.target ) ) menu.style.display = 'none';
      } );
    } );

    /* Auth state */
    onAuthStateChanged( auth, async user => {
      if ( !user ) {
        location.hash = '#login';
        show( 'login' );
        return;
      }

      if ( user.photoURL ) userIcon.src = user.photoURL;

      // ‚òÖ ÂøÖ„Åö„Åì„Åì„ÅßÈÅ∑ÁßªÂá¶ÁêÜ
      if ( !location.hash || location.hash === '#login' ) {
        location.hash = '#/list';
      }

      await navigate(); // ‚Üê ÂøÖ„ÅöÂëº„Å∂
    } );
    window.addEventListener( 'hashchange', () => {
      if ( !auth.currentUser ) return;
      navigate();
    } );

    async function loadMetaOnce() {
      if ( metaCache ) return metaCache;

      let metaWasFixed = false;

      const metaRef = doc( db, 'users', auth.currentUser.uid, 'meta', 'main' );
      const snap = await getDoc( metaRef );

      if ( snap.exists() ) {
        metaCache = snap.data();
        if ( !Array.isArray( metaCache.memos ) ) {
          metaCache.memos = [];
          metaWasFixed = true;
        }
      } else {
        metaCache = { memos: [] };
        metaWasFixed = true;
      }

      // üîÅ meta „ÅåÁ©∫„Å™„Çâ Firestore „Åã„Çâ1Âõû„Å†„ÅëÂæ©ÂÖÉ
      if ( metaCache.memos.length === 0 ) {
        const memosSnap = await getDocs(
          collection( db, 'users', auth.currentUser.uid, 'memos' )
        );

        metaCache.memos = memosSnap.docs.map( d => {
          const m = d.data();
          return {
            id: d.id,
            title: m.title || '',
            updated: m.updated || Date.now(),
            deleted: !!m.deletedAt
          };
        } );

        metaWasFixed = true;
      }

      // üß† Ê≠£Ë¶èÂåñÔºàÂ£ä„Çå„Åü„Éá„Éº„ÇøÈò≤Ê≠¢Ôºâ
      metaCache.memos.forEach( m => {
        if ( typeof m.deleted !== 'boolean' ) {
          m.deleted = false;
          metaWasFixed = true;
        }
        if ( typeof m.title !== 'string' ) {
          m.title = '';
          metaWasFixed = true;
        }
        if ( typeof m.updated !== 'number' ) {
          m.updated = Date.now();
          metaWasFixed = true;
        }
      } );

      // ‚úÖ „ÄåÁõ¥„Åó„ÅüÊôÇ„Å†„Åë„Äç‰øùÂ≠ò
      if ( metaWasFixed ) {
        await setDoc( metaRef, metaCache );
      }

      return metaCache;
    } async function loadMemos() {
      await loadMetaOnce();
      memoList.innerHTML = '';

      metaCache.memos
        .filter( m => !m.deleted )
        .sort( ( a, b ) => b.updated - a.updated )
        .forEach( m => {

          const li = document.createElement( 'li' );

          const titleSpan = document.createElement( 'span' );
          titleSpan.className = 'memo-title';
          titleSpan.textContent = m.title || 'Untitled';
          li.appendChild( titleSpan );

          /* Âè≥ÂÅ¥ */
          const rightDiv = document.createElement( 'div' );
          rightDiv.className = 'memo-right';

          const dateSpan = document.createElement( 'span' );
          dateSpan.className = 'date-span';
          dateSpan.textContent =
            new Date( m.updated ).toLocaleString( 'ja-JP', {
              year: 'numeric', month: '2-digit', day: '2-digit',
              hour: '2-digit', minute: '2-digit'
            } );

          /* ‚ãØ „É°„Éã„É•„Éº */
          const menuBtn = document.createElement( 'button' );
          menuBtn.textContent = '‚ãØ';
          menuBtn.className = 'menu-btn';

          const menuPopup = document.createElement( 'div' );
          menuPopup.className = 'menu-popup';

          const copyBtn = document.createElement( 'button' );
          copyBtn.textContent = '‚ùê';
          copyBtn.onclick = async ( e ) => {
            e.stopPropagation();
            const snap = await getDoc(
              doc( db, 'users', auth.currentUser.uid, 'memos', m.id )
            );
            navigator.clipboard.writeText( snap.data()?.content || '' );
            showToast( 'Copied' );
            menuPopup.style.display = 'none';
          };

          const delBtn = document.createElement( 'button' );
          delBtn.textContent = 'üóëÔ∏è';
          delBtn.onclick = async ( e ) => {
            e.stopPropagation();
            m.deleted = true;
            m.updated = Date.now();
            await saveMeta();
            loadMemos();
            showToast( 'Moved to Trash' );
            menuPopup.style.display = 'none';
          };

          menuPopup.append( copyBtn, delBtn );
          menuBtn.onclick = e => {
            e.stopPropagation();
            menuPopup.style.display =
              menuPopup.style.display === 'block' ? 'none' : 'block';
          };

          rightDiv.append( dateSpan, menuBtn, menuPopup );
          li.appendChild( rightDiv );

          li.onclick = () => {
            location.hash = `#/editor/${m.id}`;
          };

          memoList.appendChild( li );
        } );
    }

    /* TrashË°®Á§∫ */
    function loadTrash() {
      if ( !metaCache || !Array.isArray( metaCache.memos ) ) return;
      trashList.innerHTML = '';

      metaCache.memos
        .filter( m => m.deleted )
        .sort( ( a, b ) => b.updated - a.updated )
        .forEach( m => {
          const li = document.createElement( 'li' );

          // „Çø„Ç§„Éà„É´
          const titleSpan = document.createElement( 'span' );
          titleSpan.textContent = m.title || 'Untitled';
          li.appendChild( titleSpan );

          // Âè≥ÂÅ¥„ÅÆÊìç‰ΩúÈ†òÂüü
          const rightDiv = document.createElement( 'div' );
          rightDiv.className = 'memo-right';

          // Êó•‰ªòË°®Á§∫
          const dateSpan = document.createElement( 'span' );
          dateSpan.className = 'date-span';
          dateSpan.textContent = new Date( m.updated ).toLocaleString( 'ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit'
          } );

          // Âæ©ÂÖÉ„Éú„Çø„É≥
          const restoreBtn = document.createElement( 'button' );
          restoreBtn.textContent = '‚Ü©Ô∏è';
          restoreBtn.onclick = async e => {
            e.stopPropagation();
            await updateMeta( m.id, { deleted: false, updated: Date.now() } );
            loadTrash();
            await loadMemos(); // „É°„É¢‰∏ÄË¶ß„ÇÇÊõ¥Êñ∞
          };

          // ‚ãØ „É°„Éã„É•„Éº
          const menuBtn = document.createElement( 'button' );
          menuBtn.textContent = '‚ãØ';
          menuBtn.className = 'menu-btn';

          const menuPopup = document.createElement( 'div' );
          menuPopup.className = 'menu-popup';

          // ÂÆåÂÖ®ÂâäÈô§„Éú„Çø„É≥
          const delBtn = document.createElement( 'button' );
          delBtn.textContent = 'Delete Permanently';
          delBtn.onclick = async e => {
            e.stopPropagation();
            // Firestore„ÅÆ„Éâ„Ç≠„É•„É°„É≥„Éà„ÇíÂâäÈô§
            await setDoc(
              doc( db, 'users', auth.currentUser.uid, 'memos', m.id ),
              {}, // Á©∫„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åß‰∏äÊõ∏„ÅçÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶ deleteDoc „Å´Â§âÊõ¥ÂèØÔºâ
              { merge: true }
            );
            // meta „Åã„Çâ„ÇÇÂâäÈô§
            metaCache.memos = metaCache.memos.filter( mm => mm.id !== m.id );
            await saveMeta();
            loadTrash();
            showToast( 'Deleted permanently' );
          };

          menuPopup.appendChild( delBtn );
          menuBtn.onclick = e => {
            e.stopPropagation();
            menuPopup.style.display =
              menuPopup.style.display === 'block' ? 'none' : 'block';
          };

          // Âè≥ÂÅ¥ div „Å´ËøΩÂä†ÔºàÈ†ÜÂ∫èÔºöÊó•‰ªò ‚Üí Âæ©ÂÖÉ ‚Üí „É°„Éã„É•„ÉºÔºâ
          rightDiv.append( dateSpan, restoreBtn, menuBtn, menuPopup );
          li.appendChild( rightDiv );

          trashList.appendChild( li );
        } );
    }
    async function openEditor( id ) {
      currentMemoId = id;

      if ( memoCache[id] ) {
        showEditor( memoCache[id] );
        return;
      }

      const snap = await getDoc( doc( db, 'users', auth.currentUser.uid, 'memos', id ) );
      const data = snap.data();
      memoCache[id] = data;
      showEditor( data );
    }

    // function showEditor(data){
    //   titleInput.value=data.title||'';
    //   editor.innerHTML=data.content||'';
    //   show('editor');
    // }

    function showEditor( data ) {
      titleInput.value = data.title || '';
      editor.innerHTML = data.content || '';
      show( 'editor' );
    }
    let saveTimer = null;

    function debounceSave() {
      clearTimeout( saveTimer );
      saveTimer = setTimeout( saveMemo, 500 );
    }

    titleInput.addEventListener( 'input', debounceSave );
    editor.addEventListener( 'input', debounceSave );

    async function saveMemo() {
      if ( !currentMemoId ) return;

      const title =
        titleInput.value.trim() ||
        editor.innerText.split( '\n' )[0]?.trim() || '';

      const content = editor.innerHTML;
      const updated = Date.now();

      memoCache[currentMemoId] = { title, content, updated };

      await setDoc(
        doc( db, 'users', auth.currentUser.uid, 'memos', currentMemoId ),
        { title, content, updated },
        { merge: true }
      );

      await updateMeta( currentMemoId, { title, updated } );
    }

    async function saveMeta() {
      await setDoc(
        doc( db, 'users', auth.currentUser.uid, 'meta', 'main' ),
        metaCache
      );
    }

    function getMeta( id ) {
      return metaCache.memos.find( m => m.id === id );
    }

    async function updateMeta( id, fields ) {
      const m = getMeta( id );
      if ( !m ) return;
      Object.assign( m, fields );
      await saveMeta();
    }
    // updateMeta(currentMemoId, title);


    /* PasteÂá¶ÁêÜÔºàBase64 Áõ¥Êé•‰øùÂ≠òÁâàÔºâ */
    editor.addEventListener( 'paste', async e => {
      e.preventDefault();
      const range = document.getSelection().getRangeAt( 0 );
      const items = e.clipboardData.items || [];
      const files = e.clipboardData.files || [];

      async function processFile( file ) {
        const img = new Image();
        img.src = URL.createObjectURL( file );
        await img.decode(); // ÁîªÂÉèË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Åæ„ÅßÂæÖ„Å§

        // „É™„Çµ„Ç§„Ç∫
        const maxWidth = 1024;
        let width = img.width;
        let height = img.height;
        if ( width > maxWidth ) {
          height = ( height / width ) * maxWidth;
          width = maxWidth;
        }

        const canvas = document.createElement( 'canvas' );
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext( '2d' );
        ctx.drawImage( img, 0, 0, width, height );

        // Canvas ‚Üí Blob „Å´Â§âÊèõ
        const blob = await new Promise( resolve => canvas.toBlob( resolve, 'image/jpeg', 0.8 ) );

        // Blob ‚Üí URL
        const blobUrl = URL.createObjectURL( blob );

        // ÊåøÂÖ•
        const imgEl = document.createElement( 'img' );
        imgEl.src = blobUrl;
        range.insertNode( imgEl );
        range.collapse( false );

        saveMemo();
      }

      // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„ÅÆ items „Åã„ÇâÁîªÂÉè„ÇíÊé¢„Åô
      for ( const item of items ) {
        if ( item.type.startsWith( 'image/' ) ) {
          const file = item.getAsFile();
          await processFile( file );
          return;
        }
      }

      // files „Åã„ÇâÁîªÂÉè„ÇíÊé¢„Åô
      if ( files.length > 0 && files[0].type.startsWith( 'image/' ) ) {
        await processFile( files[0] );
        return;
      }

      // 2Ô∏è‚É£ „ÉÜ„Ç≠„Çπ„ÉàÂá¶ÁêÜ
      const text = e.clipboardData.getData( 'text/plain' );
      const url = text.trim();

      // helper: insert element and collapse
      const insertEl = ( el ) => { range.insertNode( el ); range.collapse( false ); saveMemo(); };

      // 2-1. YouTube
      let yt = url.match( /(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/ );
      if ( yt ) {
        const wrap = document.createElement( 'div' );
        wrap.className = 'video';
        const iframe = document.createElement( 'iframe' );
        iframe.src = `https://www.youtube-nocookie.com/embed/${yt[1]}?modestbranding=1&rel=0&playsinline=1`;
        iframe.allowFullscreen = true;
        wrap.appendChild( iframe );
        insertEl( wrap );
        return;
      }

      // 2-2. „Éã„Ç≥„Éã„Ç≥ÂãïÁîª
      // „Éã„Ç≥„Éã„Ç≥ÂãïÁîª
// „Éã„Ç≥„Éã„Ç≥ÂãïÁîª
let nico = url.match( /nicovideo\.jp\/watch\/([\w]+)/ );
if ( nico ) {
  const wrap = document.createElement('div');
  wrap.className = 'video'; // YouTube„Å®Âêå„Åò„ÇØ„É©„Çπ

  const iframe = document.createElement('iframe');
  iframe.src = `https://embed.nicovideo.jp/watch/${nico[1]}`;
  iframe.setAttribute('frameborder', '0');
  iframe.setAttribute('allowfullscreen', ''); // „Åì„Åì„ÅåÈáçË¶Å
  iframe.setAttribute('allow', 'fullscreen');
  wrap.appendChild(iframe);

  insertEl(wrap);
  return;
}
// 2-3. TikTok
const tiktok = url.match(/https:\/\/(www\.)?tiktok\.com\/.*\/video\/(\d+)/);
if (tiktok) {
  const videoId = tiktok[2];
  const wrap = document.createElement('div');
  wrap.className = 'video';

  const iframe = document.createElement('iframe');
  iframe.src = `https://www.tiktok.com/embed/${videoId}`;
  iframe.allow = "autoplay; fullscreen";
  iframe.allowFullscreen = true;

  wrap.appendChild(iframe);
  range.insertNode(wrap);
  range.collapse(false);
  saveMemo();
  return;
}

      // 2-6. ÁîªÂÉè

      const imgRegex = /https?:\/\/\S+\.(?:png|jpg|jpeg|gif)/i;
      if ( imgRegex.test( url ) ) {
        const img = document.createElement( 'img' );
        img.src = url;
        img.style.cursor = 'pointer';

        img.addEventListener( 'click', e => {
          e.preventDefault();
          e.stopPropagation(); // ‚Üê Ë∂ÖÈáçË¶Å
          window.open( url, '_blank', 'noopener' );
        } );

        insertEl( img );
        return;
      }

      //   // 2-7. ÈÄöÂ∏∏URLÔºà„Ç´„Éº„ÉâÔºãÁîüURLË°®Á§∫Ôºâ
      //   const linkRegex = /^https?:\/\/\S+$/;
      //   if ( linkRegex.test( url ) ) {
      //     const container = document.createElement( 'div' );
      //     container.style.margin = '8px 0';

      //     // „Ç´„Éº„ÉâÊú¨‰Ωì
      //     const card = document.createElement( 'div' );
      //     card.style.border = '1px solid #ddd';
      //     card.style.borderRadius = '6px';
      //     card.style.padding = '8px';
      //     card.style.display = 'flex';
      //     card.style.alignItems = 'center';
      //     card.style.gap = '8px';
      //     card.style.cursor = 'pointer';
      //     card.contentEditable = false;

      //     const icon = document.createElement( 'img' );
      //     icon.src = 'https://www.google.com/s2/favicons?domain=' + url;
      //     icon.width = 16;
      //     icon.height = 16;

      //     const titleSpan = document.createElement( 'span' );
      //     titleSpan.style.fontWeight = 'bold';
      //     titleSpan.style.fontSize = '0.9em';
      //     titleSpan.style.overflow = 'hidden';
      //     titleSpan.style.textOverflow = 'ellipsis';
      //     titleSpan.style.whiteSpace = 'nowrap';

      //     // „Çø„Ç§„Éà„É´ÂèñÂæóÔºàÂ§±Êïó„Åó„Åü„ÇâÂøÖ„Åö„Éõ„Çπ„ÉàÂêçÔºâ
      //     ( async () => {
      //       let text = '';

      //       try {
      //         const res = await fetch( url, { mode: 'cors' } );
      //         const html = await res.text();
      //         const doc = new DOMParser().parseFromString( html, 'text/html' );
      //         const title = doc.querySelector( 'title' )?.innerText?.trim();
      //         if ( title ) text = title;
      //       } catch { }

      //       // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºö„Éõ„Çπ„ÉàÂêç
      //       if ( !text ) {
      //         try {
      //           text = new URL( url ).hostname;
      //         } catch { }
      //       }

      //       if ( text ) {
      //         titleSpan.textContent = text;
      //         titleSpan.style.display = '';
      //       } else {
      //         titleSpan.style.display = 'none';
      //       }
      //     } )();

      //     card.append( icon, titleSpan );

      //     card.addEventListener( 'click', e => {
      //       e.preventDefault();
      //       e.stopPropagation();
      //       window.open( url, '_blank', 'noopener' );
      //     } );

      //     // Áîü„É™„É≥„ÇØÔºà„ÅÑ„Åò„Çâ„Å™„ÅÑÔºâ
      //     const linkLine = document.createElement( 'a' );
      //     linkLine.href = url;
      //     linkLine.textContent = url;
      //     linkLine.target = '_blank';
      //     linkLine.rel = 'noopener';
      //     linkLine.style.display = 'block';
      //     linkLine.style.marginTop = '4px';

      //     container.append( card, linkLine );
      //     insertEl( container );
      //     return;
      //   }
      //   // 2-8. ÈÄöÂ∏∏„ÉÜ„Ç≠„Çπ„Éà
      insertEl( document.createTextNode( url ) );
    } );

    // // contenteditable ÂÜÖ„ÅÆ„É™„É≥„ÇØ„ÇíÂÜçË°®Á§∫Âæå„ÇÇÁ¢∫ÂÆü„Å´Èñã„Åë„Çã„Çà„ÅÜ„Å´„Åô„Çã
    // editor.addEventListener( 'click', e => {
    //   const a = e.target.closest( 'a' );
    //   if ( !a ) return;

    //   const href = a.getAttribute( 'href' );
    //   if ( !href ) return;

    //   e.preventDefault();
    //   e.stopPropagation();
    //   window.open( href, '_blank', 'noopener' );
    // } );

    /* Preview */
    function showPreview( id, title, content ) {
      previewContent.innerHTML = `<strong>${title}</strong><br>${content}`;
      preview.style.display = 'block';
      copyBtn.onclick = () => { navigator.clipboard.writeText( content || '' ); showToast( 'Copied' ); }
      deleteBtn.onclick = async () => {
        await updateMeta( id, { deleted: true, updated: Date.now() } );
        preview.style.display = 'none';
        showToast( 'Moved to Trash' );
        loadMemos(); // ‚Üê „Åì„Çå
      }
      closePreview.onclick = () => preview.style.display = 'none';
    }

    document.getElementById( 'go-trash' ).onclick = () => { location.hash = '#/trash'; }
    document.getElementById( 'back-list' ).onclick = () => { location.hash = '#/list'; }
    document.getElementById( 'back' ).onclick = () => { if ( history.length > 1 ) history.back(); else location.hash = '#/list'; }
    /* New memo button */
    document.getElementById( 'new-memo' ).onclick = async () => {
      await loadMetaOnce(); // ‚Üê ÂøÖ„ÅöÂÖà„Å´Âëº„Å∂
      // Êú¨Êñá„Éâ„Ç≠„É•„É°„É≥„Éà„Çí1‰ª∂„Å†„Åë‰Ωú„Çã
      const ref = await addDoc(
        collection( db, 'users', auth.currentUser.uid, 'memos' ),
        { title: '', content: '', updated: Date.now() }
      );

      // metaÔºàÁõÆÊ¨°ÁÆ±Ôºâ„Å´ËøΩÂä†
      metaCache.memos.push( {
        id: ref.id,
        title: '',
        updated: Date.now(),
        deleted: false
      } );

      // meta‰øùÂ≠ò
      await setDoc(
        doc( db, 'users', auth.currentUser.uid, 'meta', 'main' ),
        metaCache
      );

      // „Ç®„Éá„Ç£„Çø„Å∏
      location.hash = `#/editor/${ref.id}`;
    };
    /* Navigation */
    async function navigate() {
      if ( !auth.currentUser ) {
        show( 'login' );
        return;
      }

      const hash = location.hash;

      if ( hash.startsWith( '#/editor/' ) ) {
        await loadMetaOnce();           // editor „Å†„Åë
        const id = hash.split( '/' )[2];
        if ( id ) await openEditor( id );

      } else if ( hash === '#/trash' ) {
        await loadMetaOnce();           // trash „Å†„Åë
        show( 'trash' );
        loadTrash();

      } else {
        await loadMetaOnce();           // list „Å†„Åë
        show( 'list' );
        await loadMemos();
      }
    }

    /* ÂàùÊúüÂåñ */
    // navigate();
  </script>
</body>

</html>
