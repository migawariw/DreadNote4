<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>DreadNote</title>
<link rel="icon" href="/DreadNote/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="DreadNote/favicon2.png" sizes="180x180">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;padding:16px;font-family:sans-serif;font-size:16px;}
section{max-width:800px;margin:auto;position:relative;}
[hidden]{display:none;}
input,button{font-size:16px;margin:4px 0;}
ul{padding-left:0;margin:0;}
li{list-style:none;padding:8px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;position:relative;user-select:none;cursor:default;}
li:hover{background:#f5f5f5;}
li .memo-title{flex:1;white-space: nowrap;overflow:hidden;text-overflow: ellipsis;margin-right:8px;}
.menu-btn, .longpress-btn{user-select:none;}
#title{width:100%;font-size:20px;margin:8px 0;border:none;padding:0;box-sizing:border-box;}
#editor{min-height:70vh;outline:none;white-space:pre-wrap;word-break:break-word;border-top:1px solid #ccc;padding-top:16px;}
img{max-width:100%;display:block;margin:8px 0;}
.video{position:relative;width:100%;padding-top:56.25%;margin:12px auto;}
.video iframe{position:absolute;inset:0;width:100%;height:100%;border:0;}
@media(max-width:768px){.video{max-width:100%;}}
.memo-right{display:flex;align-items:center;gap:8px;}
.date-span{font-size:0.7em;color:#666;flex-shrink:0;}
.menu-btn{background:none;border:none;font-size:16px;cursor:pointer;}
.menu-popup{position:absolute;top:100%;right:0;background:#fff;border:1px solid #ccc;padding:4px 0;box-shadow:0 2px 6px rgba(0,0,0,0.2);display:none;z-index:10;}
.menu-popup button{width:100%;text-align:left;padding:4px 12px;background:none;border:none;cursor:pointer;}
.menu-popup button:hover{background:#eee;}
#user-icon{width:32px;height:32px;border-radius:50%;cursor:pointer;position:relative;}
#user-menu{position:absolute;top:40px;right:0;background:#fff;border:1px solid #ccc;display:none;z-index:100;white-space:nowrap;}
#toast{display:none;position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:12px 24px;border-radius:8px;opacity:0;pointer-events:none;transition:opacity 0.3s ease;z-index:1000;}
#toast.show{display:block;opacity:1;pointer-events:auto;}
.preview-popup{display:none;position:fixed;background:#fff;border:1px solid #333;padding:8px;z-index:1000;max-width:80%;box-shadow:0 2px 6px rgba(0,0,0,0.3);}
button{cursor:pointer;}
.flex-between{display:flex;justify-content:space-between;align-items:center;}
.longpress-btn{background:#eee;border:1px solid #ccc;padding:4px 8px;border-radius:4px;user-select:none;cursor:pointer;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>

<section id="view-login">
  <h2>DreadNote Login</h2>
  <input id="email" placeholder="email"><br>
  <input id="password" type="password" placeholder="password"><br>
  <button id="login">Login</button>
  <button id="signup">Sign up</button><br><br>
  <button id="google-login">Login with Google</button>
</section>

<section id="view-list" hidden>
  <div class="flex-between">
    <h2>Notes</h2>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="new-memo">ï¼‹</button>
      <button id="go-trash">ğŸ—‘ï¸</button>
      <img id="user-icon" src="" title="User Menu">
      <div id="user-menu">
        <button id="switch-account">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡æ›¿</button>
        <button id="logout-btn">LogOut</button>
      </div>
    </div>
  </div>
  <ul id="memo-list"></ul>
</section>

<section id="view-trash" hidden>
  <div class="flex-between">
    <h2>TrashğŸ—‘ï¸</h2>
    <button id="back-list"> â† </button>
  </div>
  <ul id="trash-list"></ul>
</section>

<section id="view-editor" hidden>
  <button id="back"> â† </button>
  <input id="title" placeholder="">
  <div id="editor" contenteditable="true"></div>
</section>

<div id="toast"></div>

<div id="preview" class="preview-popup">
  <div id="preview-content"></div>
  <button id="copy-note">Copy</button>
  <button id="delete-note">Delete</button>
  <button id="close-preview">Close</button>
</div>

<script type="module">
import { getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let metaCache = null;        // â† ç›®æ¬¡ç®±
const memoCache = {};       // â† æœ¬æ–‡ã‚­ãƒ£ãƒƒã‚·ãƒ¥

/* FirebaseåˆæœŸåŒ– */
const firebaseConfig = { apiKey:"AIzaSyCdDf0GH80PoGlcbk2yjlaVQfP01Gk9m18", authDomain:"noteeditor-ba1db.firebaseapp.com", projectId:"noteeditor-ba1db" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* DOMè¦ç´  */
const views={login:document.getElementById('view-login'),list:document.getElementById('view-list'),trash:document.getElementById('view-trash'),editor:document.getElementById('view-editor')};
const emailInput=document.getElementById('email');
const passwordInput=document.getElementById('password');
const memoList=document.getElementById('memo-list');
const trashList=document.getElementById('trash-list');
const editor=document.getElementById('editor');
const titleInput=document.getElementById('title');
const userIcon=document.getElementById('user-icon');
const userMenu=document.getElementById('user-menu');
const toast=document.getElementById('toast');
const preview=document.getElementById('preview');
const previewContent=document.getElementById('preview-content');
const copyBtn=document.getElementById('copy-note');
const deleteBtn=document.getElementById('delete-note');
const closePreview=document.getElementById('close-preview');

let currentMemoId=null;
let longPressTimer=null;
// let memosCache=[];

/* ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º */
function showToast(msg,d=2000){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),d); }
function show(view){ Object.values(views).forEach(v=>v.hidden=true); views[view].hidden=false; }

/* Auth */
const provider=new GoogleAuthProvider();
document.getElementById('login').onclick=async()=>{ try{ await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value); } catch(e){ showToast("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: "+e.message); } };
document.getElementById('signup').onclick=async()=>{ try{ await createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value); } catch(e){ showToast("ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—: "+e.message); } };
document.getElementById('google-login').onclick=async()=>{ try{ await signInWithPopup(auth,provider); } catch(e){ showToast("Googleãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: "+e.message); } };
userIcon.onclick=()=>{ userMenu.style.display=(userMenu.style.display==='block')?'none':'block'; }
document.getElementById('switch-account').onclick=async()=>{ userMenu.style.display='none'; try{ await signInWithPopup(auth,provider); } catch(e){ showToast("åˆ‡æ›¿å¤±æ•—"); } }
document.getElementById('logout-btn').onclick=()=>{ userMenu.style.display='none'; signOut(auth); location.hash='#login'; }
document.addEventListener('click',e=>{
  if(!userMenu.contains(e.target) && e.target!==userIcon) userMenu.style.display='none';
  document.querySelectorAll('.menu-popup').forEach(menu=>{
    const btn = menu.previousSibling;
    if(!menu.contains(e.target) && !btn.contains(e.target)) menu.style.display='none';
  });
});

/* Auth state */
onAuthStateChanged(auth, async user => {
  if (!user) {
    location.hash = '#login';
    show('login');
    return;
  }

  if (user.photoURL) userIcon.src = user.photoURL;

  // â˜… å¿…ãšã“ã“ã§é·ç§»å‡¦ç†
  if (!location.hash || location.hash === '#login') {
    location.hash = '#/list';
  }

  await navigate(); // â† å¿…ãšå‘¼ã¶
});
window.addEventListener('hashchange', ()=>{
  if (!auth.currentUser) return;
  navigate();
});

/* Firestoreã‚­ãƒ£ãƒƒã‚·ãƒ¥ + å³ãƒœã‚¿ãƒ³ + Trash + ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œ */
// let unsubscribe=null;
// async function loadMemos(){
//   if(unsubscribe) unsubscribe(); // å¤ã„listenerè§£é™¤
//   const q=query(collection(db,'users',auth.currentUser.uid,'memos'), orderBy('updated','desc'));
//   unsubscribe = onSnapshot(q, snap=>{
//     memosCache = snap.docs.map(d=>({id:d.id,...d.data()}));
//     renderMemos();
//   });
// }
async function loadMetaOnce(){
  if (metaCache) return metaCache;

  let metaWasFixed = false;

  const metaRef = doc(db,'users',auth.currentUser.uid,'meta','main');
  const snap = await getDoc(metaRef);

  if (snap.exists()) {
    metaCache = snap.data();
    if (!Array.isArray(metaCache.memos)) {
      metaCache.memos = [];
      metaWasFixed = true;
    }
  } else {
    metaCache = { memos: [] };
    metaWasFixed = true;
  }

  // ğŸ” meta ãŒç©ºãªã‚‰ Firestore ã‹ã‚‰1å›ã ã‘å¾©å…ƒ
  if (metaCache.memos.length === 0) {
    const memosSnap = await getDocs(
      collection(db,'users',auth.currentUser.uid,'memos')
    );

    metaCache.memos = memosSnap.docs.map(d => {
      const m = d.data();
      return {
        id: d.id,
        title: m.title || '',
        updated: m.updated || Date.now(),
        deleted: !!m.deletedAt
      };
    });

    metaWasFixed = true;
  }

  // ğŸ§  æ­£è¦åŒ–ï¼ˆå£Šã‚ŒãŸãƒ‡ãƒ¼ã‚¿é˜²æ­¢ï¼‰
  metaCache.memos.forEach(m => {
    if (typeof m.deleted !== 'boolean') {
      m.deleted = false;
      metaWasFixed = true;
    }
    if (typeof m.title !== 'string') {
      m.title = '';
      metaWasFixed = true;
    }
    if (typeof m.updated !== 'number') {
      m.updated = Date.now();
      metaWasFixed = true;
    }
  });

  // âœ… ã€Œç›´ã—ãŸæ™‚ã ã‘ã€ä¿å­˜
  if (metaWasFixed) {
    await setDoc(metaRef, metaCache);
  }

  return metaCache;
}async function loadMemos(){
  await loadMetaOnce();
  memoList.innerHTML='';

  metaCache.memos
    .filter(m => !m.deleted)
    .sort((a,b)=>b.updated - a.updated)
    .forEach(m => {

      const li = document.createElement('li');

      const titleSpan = document.createElement('span');
      titleSpan.className = 'memo-title';
      titleSpan.textContent = m.title || 'Untitled';
      li.appendChild(titleSpan);

      /* å³å´ */
      const rightDiv = document.createElement('div');
      rightDiv.className = 'memo-right';

      const dateSpan = document.createElement('span');
      dateSpan.className = 'date-span';
      dateSpan.textContent =
        new Date(m.updated).toLocaleString('ja-JP',{
          year:'numeric',month:'2-digit',day:'2-digit',
          hour:'2-digit',minute:'2-digit'
        });

      /* â‹¯ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
      const menuBtn = document.createElement('button');
      menuBtn.textContent = 'â‹¯';
      menuBtn.className = 'menu-btn';

      const menuPopup = document.createElement('div');
      menuPopup.className = 'menu-popup';

      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'â';
      copyBtn.onclick = async(e)=>{
        e.stopPropagation();
        const snap = await getDoc(
          doc(db,'users',auth.currentUser.uid,'memos',m.id)
        );
        navigator.clipboard.writeText(snap.data()?.content || '');
        showToast('Copied');
        menuPopup.style.display='none';
      };

      const delBtn = document.createElement('button');
      delBtn.textContent = 'ğŸ—‘ï¸';
      delBtn.onclick = async(e)=>{
        e.stopPropagation();
        m.deleted = true;
        m.updated = Date.now();
        await saveMeta();
        loadMemos();
        showToast('Moved to Trash');
        menuPopup.style.display='none';
      };

      menuPopup.append(copyBtn, delBtn);
      menuBtn.onclick = e=>{
        e.stopPropagation();
        menuPopup.style.display =
          menuPopup.style.display === 'block' ? 'none' : 'block';
      };

      rightDiv.append(dateSpan, menuBtn, menuPopup);
      li.appendChild(rightDiv);

      li.onclick = ()=>{
        location.hash = `#/editor/${m.id}`;
      };

      memoList.appendChild(li);
    });
}// function renderMemos(){
//   memoList.innerHTML='';
//   memosCache.filter(m=>!m.deletedAt).forEach(data=>{
//     const li=document.createElement('li');
//     const titleSpan=document.createElement('span'); titleSpan.className='memo-title'; titleSpan.textContent=data.title||'Untitled';
//     li.appendChild(titleSpan);

//     const rightDiv=document.createElement('div'); rightDiv.className='memo-right';
//     const dateSpan=document.createElement('span'); dateSpan.className='date-span';
//     dateSpan.textContent=new Date(data.updated).toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
//     const menuBtn=document.createElement('button'); menuBtn.textContent='â‹¯'; menuBtn.className='menu-btn longpress-btn';
//     const menuPopup=document.createElement('div'); menuPopup.className='menu-popup';
//     const copyAction=document.createElement('button'); copyAction.textContent='Copy';
//     copyAction.onclick=async(e)=>{ e.stopPropagation(); navigator.clipboard.writeText(data.content||''); showToast('Copied'); menuPopup.style.display='none'; }
//     const deleteAction=document.createElement('button'); deleteAction.textContent='âŒ';
//     deleteAction.onclick=async(e)=>{ e.stopPropagation(); await setDoc(doc(db,'users',auth.currentUser.uid,'memos',data.id),{deletedAt:Date.now()},{merge:true}); showToast('Moved to Trash'); menuPopup.style.display='none'; }
//     menuPopup.append(copyAction,deleteAction);
//     menuBtn.onclick=(e)=>{ e.stopPropagation(); menuPopup.style.display=(menuPopup.style.display==='block')?'none':'block'; }
//     rightDiv.append(dateSpan,menuBtn,menuPopup);
//     li.appendChild(rightDiv);

//     /* é•·æŠ¼ã—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
//     menuBtn.addEventListener('mousedown',()=>{ longPressTimer=setTimeout(()=>{ showPreview(data.id,data.title,data.content); },500); });
//     menuBtn.addEventListener('mouseup',()=>{ clearTimeout(longPressTimer); });
//     menuBtn.addEventListener('mouseleave',()=>{ clearTimeout(longPressTimer); });
//     menuBtn.addEventListener('touchstart',()=>{ longPressTimer=setTimeout(()=>{ showPreview(data.id,data.title,data.content); },500); });
//     menuBtn.addEventListener('touchend',()=>{ clearTimeout(longPressTimer); });

//     li.onclick=()=>location.hash=`#/editor/${data.id}`;
//     memoList.appendChild(li);
//   });
// }

/* Trashè¡¨ç¤º */
function loadTrash() {
  if (!metaCache || !Array.isArray(metaCache.memos)) return;
  trashList.innerHTML = '';

  metaCache.memos
    .filter(m => m.deleted)
    .sort((a,b) => b.updated - a.updated)
    .forEach(m => {
      const li = document.createElement('li');

      // ã‚¿ã‚¤ãƒˆãƒ«
      const titleSpan = document.createElement('span');
      titleSpan.textContent = m.title || 'Untitled';
      li.appendChild(titleSpan);

      // å³å´ã®æ“ä½œé ˜åŸŸ
      const rightDiv = document.createElement('div');
      rightDiv.className = 'memo-right';

      // æ—¥ä»˜è¡¨ç¤º
      const dateSpan = document.createElement('span');
      dateSpan.className = 'date-span';
      dateSpan.textContent = new Date(m.updated).toLocaleString('ja-JP', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });

      // å¾©å…ƒãƒœã‚¿ãƒ³
      const restoreBtn = document.createElement('button');
      restoreBtn.textContent = 'â†©ï¸';
      restoreBtn.onclick = async e => {
        e.stopPropagation();
        await updateMeta(m.id, {deleted: false, updated: Date.now()});
        loadTrash();
        await loadMemos(); // ãƒ¡ãƒ¢ä¸€è¦§ã‚‚æ›´æ–°
      };

      // â‹¯ ãƒ¡ãƒ‹ãƒ¥ãƒ¼
      const menuBtn = document.createElement('button');
      menuBtn.textContent = 'â‹¯';
      menuBtn.className = 'menu-btn';

      const menuPopup = document.createElement('div');
      menuPopup.className = 'menu-popup';

      // å®Œå…¨å‰Šé™¤ãƒœã‚¿ãƒ³
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete Permanently';
      delBtn.onclick = async e => {
        e.stopPropagation();
        // Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
        await setDoc(
          doc(db, 'users', auth.currentUser.uid, 'memos', m.id),
          {}, // ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ä¸Šæ›¸ãï¼ˆå¿…è¦ã«å¿œã˜ã¦ deleteDoc ã«å¤‰æ›´å¯ï¼‰
          {merge:true}
        );
        // meta ã‹ã‚‰ã‚‚å‰Šé™¤
        metaCache.memos = metaCache.memos.filter(mm => mm.id !== m.id);
        await saveMeta();
        loadTrash();
        showToast('Deleted permanently');
      };

      menuPopup.appendChild(delBtn);
      menuBtn.onclick = e => {
        e.stopPropagation();
        menuPopup.style.display =
          menuPopup.style.display === 'block' ? 'none' : 'block';
      };

      // å³å´ div ã«è¿½åŠ ï¼ˆé †åºï¼šæ—¥ä»˜ â†’ å¾©å…ƒ â†’ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
      rightDiv.append(dateSpan, restoreBtn, menuBtn, menuPopup);
      li.appendChild(rightDiv);

      trashList.appendChild(li);
    });
}
async function openEditor(id){
  currentMemoId=id;

  if(memoCache[id]){
    showEditor(memoCache[id]);
    return;
  }

  const snap=await getDoc(doc(db,'users',auth.currentUser.uid,'memos',id));
  const data=snap.data();
  memoCache[id]=data;
  showEditor(data);
}

// function showEditor(data){
//   titleInput.value=data.title||'';
//   editor.innerHTML=data.content||'';
//   show('editor');
// }

function showEditor(data){
  titleInput.value = data.title || '';
  editor.innerHTML = data.content || '';
  show('editor');
}
let saveTimer=null;

function debounceSave(){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(saveMemo,500);
}

titleInput.addEventListener('input',debounceSave);
editor.addEventListener('input',debounceSave);

async function saveMemo(){
  if(!currentMemoId) return;

  const title =
    titleInput.value.trim() ||
    editor.innerText.split('\n')[0]?.trim() || '';

  const content = editor.innerHTML;
  const updated = Date.now();

  memoCache[currentMemoId]={title,content,updated};

  await setDoc(
    doc(db,'users',auth.currentUser.uid,'memos',currentMemoId),
    {title,content,updated},
    {merge:true}
  );

  await updateMeta(currentMemoId,{title,updated});
}

async function saveMeta(){
  await setDoc(
    doc(db,'users',auth.currentUser.uid,'meta','main'),
    metaCache
  );
}

function getMeta(id){
  return metaCache.memos.find(m=>m.id===id);
}

async function updateMeta(id, fields){
  const m = getMeta(id);
  if(!m) return;
  Object.assign(m, fields);
  await saveMeta();
}
// updateMeta(currentMemoId, title);


/* Pasteå‡¦ç†ï¼ˆBase64 ç›´æ¥ä¿å­˜ç‰ˆï¼‰ */
editor.addEventListener('paste', async e => {
  e.preventDefault();
  const range = document.getSelection().getRangeAt(0);
  const items = e.clipboardData.items || [];
  const files = e.clipboardData.files || [];

  async function processFile(file) {
    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode(); // ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†ã¾ã§å¾…ã¤

    // ãƒªã‚µã‚¤ã‚º
    const maxWidth = 1024;
    let width = img.width;
    let height = img.height;
    if (width > maxWidth) {
      height = (height / width) * maxWidth;
      width = maxWidth;
    }

    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);

    // Canvas â†’ Blob ã«å¤‰æ›
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));

    // Blob â†’ URL
    const blobUrl = URL.createObjectURL(blob);

    // æŒ¿å…¥
    const imgEl = document.createElement('img');
    imgEl.src = blobUrl;
    range.insertNode(imgEl);
    range.collapse(false);

    saveMemo();
  }

  // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã® items ã‹ã‚‰ç”»åƒã‚’æ¢ã™
  for (const item of items) {
    if (item.type.startsWith('image/')) {
      const file = item.getAsFile();
      await processFile(file);
      return;
    }
  }

  // files ã‹ã‚‰ç”»åƒã‚’æ¢ã™
  if (files.length > 0 && files[0].type.startsWith('image/')) {
    await processFile(files[0]);
    return;
  }

  // 2ï¸âƒ£ ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†
  const text = e.clipboardData.getData('text/plain');
  const url = text.trim();

  // helper: insert element and collapse
  const insertEl = (el) => { range.insertNode(el); range.collapse(false); saveMemo(); };

  // 2-1. YouTube
  let yt = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/);
  if (yt) {
    const wrap = document.createElement('div');
    wrap.className = 'video';
    const iframe = document.createElement('iframe');
    iframe.src = `https://www.youtube-nocookie.com/embed/${yt[1]}?modestbranding=1&rel=0&playsinline=1`;
    iframe.allowFullscreen = true;
    wrap.appendChild(iframe);
    insertEl(wrap);
    return;
  }

  // 2-2. ãƒ‹ã‚³ãƒ‹ã‚³å‹•ç”»
  let nico = url.match(/nicovideo\.jp\/watch\/([\w]+)/);
  if (nico){
    const wrap = document.createElement('iframe');
    wrap.src = `https://embed.nicovideo.jp/watch/${nico[1]}`;
    wrap.frameBorder = "0";
    insertEl(wrap);
    return;
  }



  // 2-7. ç”»åƒURLç›´æ¥
  // ç”»åƒURL
const imgRegex = /https?:\/\/\S+\.(?:png|jpg|jpeg|gif)/i;
// PDF URL
const pdfRegex = /https?:\/\/\S+\.pdf/i;

// ç”»åƒã®å ´åˆï¼ˆæ—¢å­˜ï¼‰
if (imgRegex.test(url)) {
  const img = document.createElement('img');
  img.src = url;
  insertEl(img);
  return;
}

// PDFã®å ´åˆï¼ˆè¿½åŠ ï¼‰
if (pdfRegex.test(url)) {
  renderPdfPages(url);
  return;
}

// ----------------------------
// PDFã‚’å…¨ãƒšãƒ¼ã‚¸æç”»ã™ã‚‹é–¢æ•°
// ----------------------------
async function renderPdfPages(pdfUrl) {
  // PDF.js ã® worker è¨­å®šï¼ˆå¿…é ˆï¼‰
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const pdf = await pdfjsLib.getDocument(pdfUrl).promise;

  for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
    const page = await pdf.getPage(pageNum);

    const scale = 1.5; // è¡¨ç¤ºå€ç‡ï¼ˆå¥½ã¿ã§èª¿æ•´ï¼‰
    const viewport = page.getViewport({ scale });

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({
      canvasContext: ctx,
      viewport
    }).promise;

    // canvas ã‚’æŒ¿å…¥
    insertEl(canvas);

    // ãƒšãƒ¼ã‚¸é–“ã«1è¡Œã‚ã‘ã‚‹
    const spacer = document.createElement('div');
    spacer.style.height = '1em';
    insertEl(spacer);
  }
}

  // 2-8. é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆ
  insertEl(document.createTextNode(url));
});

/* Preview */
function showPreview(id,title,content){
  previewContent.innerHTML=`<strong>${title}</strong><br>${content}`;
  preview.style.display='block';
  copyBtn.onclick=()=>{ navigator.clipboard.writeText(content||''); showToast('Copied'); }
  deleteBtn.onclick=async()=>{
    await updateMeta(id,{deleted:true,updated:Date.now()});
	preview.style.display='none';
	showToast('Moved to Trash');
	loadMemos(); // â† ã“ã‚Œ
  }
  closePreview.onclick=()=>preview.style.display='none';
}

/* Navigation buttons */
// document.getElementById('new-memo').onclick=async()=>{
//   const ref = await addDoc(collection(db,'users',auth.currentUser.uid,'memos'), {title:'',content:'',updated:Date.now(),deletedAt:null});
// //   memosCache.push({id:ref.id,title:'',content:'',updated:Date.now(),deletedAt:null});
//   location.hash=`#/editor/${ref.id}`;
// }
document.getElementById('go-trash').onclick=()=>{ location.hash='#/trash'; }
document.getElementById('back-list').onclick=()=>{ location.hash='#/list'; }
document.getElementById('back').onclick=()=>{ if(history.length>1) history.back(); else location.hash='#/list'; }
/* New memo button */
document.getElementById('new-memo').onclick = async () => {
  await loadMetaOnce(); // â† å¿…ãšå…ˆã«å‘¼ã¶
  // æœ¬æ–‡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’1ä»¶ã ã‘ä½œã‚‹
  const ref = await addDoc(
    collection(db,'users',auth.currentUser.uid,'memos'),
    { title:'', content:'', updated: Date.now() }
  );

  // metaï¼ˆç›®æ¬¡ç®±ï¼‰ã«è¿½åŠ 
  metaCache.memos.push({
    id: ref.id,
    title: '',
    updated: Date.now(),
    deleted: false
  });

  // metaä¿å­˜
  await setDoc(
    doc(db,'users',auth.currentUser.uid,'meta','main'),
    metaCache
  );

  // ã‚¨ãƒ‡ã‚£ã‚¿ã¸
  location.hash = `#/editor/${ref.id}`;
};
/* Navigation */
async function navigate(){
  if (!auth.currentUser) {
    show('login');
    return;
  }

  const hash = location.hash;

  if (hash.startsWith('#/editor/')) {
    await loadMetaOnce();           // editor ã ã‘
    const id = hash.split('/')[2];
    if (id) await openEditor(id);

  } else if (hash === '#/trash') {
    await loadMetaOnce();           // trash ã ã‘
    show('trash');
    loadTrash();

  } else {
    await loadMetaOnce();           // list ã ã‘
    show('list');
    await loadMemos();
  }
}

/* åˆæœŸåŒ– */
// navigate();
</script>
</body>
</html>
  
